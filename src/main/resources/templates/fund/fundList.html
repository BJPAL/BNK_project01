<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="/css/fund/fund_list.css" />
        <title>펀드 투자 - 맞춤 추천</title>
    </head>
    <body>
        <div class="container">
            <!-- 제목 영역 -->
            <div class="title-container">
                <h1 class="title">맞춤 펀드 추천</h1>
                <span class="title-user-info">
                    현재 회원님의 투자성향은
                    <span id="invest-type">Unknown</span>입니다
                </span>
            </div>

            <!-- 필터 영역 -->
            <form id="fundForm" class="filter-container">
                <!-- 위험등급 -->
                <fieldset class="row">
                    <legend class="row-label">위험등급</legend>
                    <div class="options">
                        <label for="risk1">
                            <input
                                type="checkbox"
                                id="risk1"
                                name="risk"
                                value="1"
                            />
                            매우높은위험(1등급)
                        </label>

                        <label for="risk2">
                            <input
                                type="checkbox"
                                id="risk2"
                                name="risk"
                                value="2"
                            />
                            높은위험(2등급)
                        </label>

                        <label for="risk3">
                            <input
                                type="checkbox"
                                id="risk3"
                                name="risk"
                                value="3"
                            />
                            다소높은위험(3등급)
                        </label>

                        <label for="risk4">
                            <input
                                type="checkbox"
                                id="risk4"
                                name="risk"
                                value="4"
                            />
                            보통위험(4등급)
                        </label>

                        <label for="risk5">
                            <input
                                type="checkbox"
                                id="risk5"
                                name="risk"
                                value="5"
                            />
                            낮은위험(5등급)
                        </label>

                        <label for="risk6">
                            <input
                                type="checkbox"
                                id="risk6"
                                name="risk"
                                value="6"
                            />
                            매우낮은위험(6등급)
                        </label>
                    </div>
                </fieldset>

                <!-- 펀드유형 -->
                <fieldset class="row">
                    <legend class="row-label">펀드유형</legend>
                    <div class="options">
                        <label for="type_mmf">
                            <input
                                type="checkbox"
                                id="type_mmf"
                                name="type"
                                value="MMF"
                            />
                            MMF
                        </label>

                        <label for="type_bond">
                            <input
                                type="checkbox"
                                id="type_bond"
                                name="type"
                                value="채권형"
                            />
                            채권형
                        </label>

                        <label for="type_bmix">
                            <input
                                type="checkbox"
                                id="type_bmix"
                                name="type"
                                value="채권혼합형"
                            />
                            채권혼합형
                        </label>

                        <label for="type_smix">
                            <input
                                type="checkbox"
                                id="type_smix"
                                name="type"
                                value="주식혼합형"
                            />
                            주식혼합형
                        </label>

                        <label for="type_stock">
                            <input
                                type="checkbox"
                                id="type_stock"
                                name="type"
                                value="주식형"
                            />
                            주식형
                        </label>

                        <label for="type_deriv">
                            <input
                                type="checkbox"
                                id="type_deriv"
                                name="type"
                                value="파생상품형"
                            />
                            파생상품형
                        </label>

                        <label for="type_fof">
                            <input
                                type="checkbox"
                                id="type_fof"
                                name="type"
                                value="재간접"
                            />
                            재간접
                        </label>
                    </div>
                </fieldset>

                <!-- 투자 지역 -->
                <fieldset class="row">
                    <legend class="row-label">투자 지역</legend>
                    <div class="options">
                        <label for="reg_kr">
                            <input
                                type="checkbox"
                                id="reg_kr"
                                name="region"
                                value="한국"
                            />
                            국내
                        </label>

                        <label for="reg_gl">
                            <input
                                type="checkbox"
                                id="reg_gl"
                                name="region"
                                value="글로벌"
                            />
                            글로벌
                        </label>
                    </div>
                </fieldset>

                <!-- 검색 버튼 -->
                <div class="row filter-btn-container">
                    <button type="submit" class="filter-btn">필터 검색</button>
                </div>
            </form>

            <div id="fund-content" class="fund-content">
                <!-- 검색 결과 메세지 영역 -->
                <div class="message"></div>

                <!-- 펀드 리스트 영역 -->
                <div id="fund-list" class="fund-list">
                    <!-- 펀드 아이템 영역 -->
                </div>

                <!-- 더보기 버튼 영역 -->
                <div class="load-more-container">
                    <button
                        id="load-more-btn"
                        class="load-more-btn"
                        onclick="loadMoreFunds()"
                    >
                        더보기
                    </button>
                </div>
            </div>

            <!-- ── 로딩 오버레이 ── -->
            <div id="loading" class="loading" hidden>
                <div class="spinner"></div>
                <p>펀드 정보를 불러오는 중...</p>
            </div>
        </div>

        <footer class="page-footer">
            <div class="footer-inner">
                <!-- 회사·서비스 정보 -->
                <section class="footer-info">
                    <h4 class="footer-logo">FUND<span>INFO</span></h4>
                    <p>
                        (주) 펀드인포 &nbsp;|&nbsp; 대표 홍길동 &nbsp;|&nbsp;
                        사업자등록번호 123‑45‑67890<br />
                        서울특별시 영등포구 여의대로 97 3F&nbsp; ( 우 07320 )
                    </p>
                    <p class="copyright">
                        © 2025 FUNDINFO Co., Ltd. All rights reserved.
                    </p>
                </section>

                <!-- 메뉴 링크 -->
                <nav class="footer-nav">
                    <ul>
                        <li><a href="#">서비스 소개</a></li>
                        <li><a href="#">이용약관</a></li>
                        <li><a href="#">개인정보처리방침</a></li>
                        <li><a href="#">고객센터</a></li>
                    </ul>
                </nav>

                <!-- SNS / 연락처 -->
                <section class="footer-contact">
                    <p>
                        <strong>고객센터 | 1588‑0000</strong
                        ><br />평일 09:00‑18:00
                    </p>
                    <div class="sns">
                        <a href="#" aria-label="페이스북">📘</a>
                        <a href="#" aria-label="트위터">🐦</a>
                        <a href="#" aria-label="링크드인">💼</a>
                    </div>
                </section>
            </div>
        </footer>

        <script>
            // 전역 변수
            let currentPage = 1; // 현재 로딩할 페이지 번호를 저장
            let pageSize = 10; // 페이지의 최대 요청 갯수
            let isLoading = false; // 현재 API 호출 중인지 상태를 나타내는 플래그
            let hasMoreData = true; // 더 가져올 데이터가 있는지 여부를 나타내는 플래그
            let investType = null; // 사용자의 투자 성향 타입 번호를 저장
            let investTypeName = ""; // 투자 성향 타입의 한글 이름을 저장
            let currentFilters = ""; // 현재 필터

            // 객체
            const loading = document.getElementById("loading");

            // 페이지 로드 시 초기화
            // HTML 문서가 완전히 로드된 후 초기화 작업 수행
            document.addEventListener("DOMContentLoaded", function () {
                // Thymeleaf에서 전달된 데이터 가져오기
                // 메타 태그 검색: document.querySelector()로 HTML의 메타 태그에서 투자 성향 정보 찾기
                const investTypeElement = document.querySelector(
                    'meta[name="invest-type"]'
                );
                const userIdElement = document.querySelector(
                    'meta[name="user-id"]'
                );

                // 데이터 파싱: parseInt()로 문자열을 숫자로 변환하여 investType 변수에 저장
                if (investTypeElement) {
                    investType = parseInt(
                        investTypeElement.getAttribute("content")
                    );
                }

                // 필터 초기화
                currentFilters = "";

                // 투자 성향 정보 설정
                // setInvestTypeInfo() 호출로 화면에 표시할 투자 성향 이름 설정
                setInvestTypeInfo();

                // 초기 데이터 로드
                // loadMoreFunds() 호출로 첫 번째 페이지 데이터 가져오기
                loadMoreFunds();
            });

            // 더 많은 펀드 로드
            // 서버에서 펀드 데이터를 가져와 화면에 추가하는 핵심 함수
            async function loadMoreFunds() {
                // 중복 호출 방지
                if (isLoading || !hasMoreData) return;

                // 로딩 상태 설정
                isLoading = true;
                showLoading(isLoading);
                updateLoadMoreButton();

                // 첫 페이지 로드인지 확인
                const isFirstLoad = currentPage === 1;

                try {
                    // 파라미터
                    let apiUrl = `/api/funds/list?page=${currentPage}&limit=${pageSize}&investType=${investType}`;

                    // 필터 파라미터가 있으면 추가
                    if (currentFilters) {
                        apiUrl += `&${currentFilters}`;
                    }

                    console.log("API 요청 URL:", apiUrl); // 디버깅용

                    // API 호출
                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    if (data.success) {
                        // 성공 시 데이터 처리
                        const funds = data.data.funds;
                        const pagination = data.pagination;

                        console.log("======= ㅋㅋ =======");
                        console.log(funds);
                        console.log(pagination);
                        console.log("======= ㅋㅋ =======");

                        // 펀드 목록 렌더링
                        renderFunds(funds);

                        // 결과 메시지 업데이트 (첫 로드일 때만)
                        if (isFirstLoad) {
                            updateResultMessage(pagination.total, true);
                        }

                        // 페이지 정보 업데이트
                        currentPage++;
                        hasMoreData = pagination.hasNext;

                        // 더보기 버튼 상태 업데이트
                        const loadMoreBtn =
                            document.getElementById("load-more-btn");

                        if (!hasMoreData) {
                            loadMoreBtn.style.display = "none";
                        } else {
                            // 더보기 버튼이 숨겨져 있다면 다시 보이게 함
                            loadMoreBtn.style.display = "block";
                        }

                        // 에러 메시지 제거
                        // clearErrorMessage();
                        console.log("펀드 데이터 갖고 옴");
                    } else {
                        console.log("펀드 정보를 불러오는데 실패했습니다");
                        if (isFirstLoad) {
                            updateResultMessage(0, true);
                        }
                        // 실패 시 에러 처리
                        // showErrorMessage(
                        //     data.message ||
                        //         "펀드 정보를 불러오는데 실패했습니다."
                        // );
                    }
                } catch (error) {
                    // 네트워크 오류 처리
                    console.error("펀드 로드 오류:", error);
                    if (isFirstLoad) {
                        updateResultMessage(0, true);
                    }
                    // showErrorMessage(
                    //     "서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요."
                    // );
                } finally {
                    // 로딩 상태 해제
                    isLoading = false;
                    showLoading(isLoading);
                    updateLoadMoreButton();
                }
            }

            // 펀드 목록 렌더링
            // 펀드 배열을 받아서 화면에 렌더링
            function renderFunds(funds) {
                // 펀드 목록을 담을 컨테이너 요소 찾기
                const fundList = document.getElementById("fund-list");

                funds.forEach((fund) => {
                    // 각 펀드의 HTML 요소 생성
                    const fundElement = createFundElement(fund);
                    // 생성된 요소를 컨테이너에 추가
                    fundList.appendChild(fundElement);
                });
            }

            // 펀드 요소 생성
            // 개별 펀드 데이터를 HTML 요소로 변환
            function createFundElement(fund) {
                const fundDiv = document.createElement("div");
                fundDiv.className = "fund-item";
                fundDiv.setAttribute("data-id", fund.fundId);

                // 수익률 클래스 결정 함수
                const getReturnClass = (value) => {
                    if (value === null || value === undefined) return "";
                    return value >= 0 ? "pos" : "neg";
                };

                // 수익률 포맷팅 함수
                const formatReturn = (value) => {
                    if (value === null || value === undefined) return "0.00%";
                    return `${value.toFixed(2)}%`;
                };

                // 숫자 포맷팅 함수
                const formatNumber = (value) => {
                    if (value === null || value === undefined) return "0";
                    return value.toLocaleString();
                };

                // 날짜 포맷팅 함수
                const formatDate = (dateStr) => {
                    if (!dateStr) return "";
                    // LocalDate는 "YYYY-MM-DD" 형태로 오므로 "-"를 "."로 변경
                    return dateStr.replace(/-/g, ".");
                };

                // 위험등급 클래스 결정
                const getRiskClass = (riskLevel) => {
                    return `risk-${riskLevel}`;
                };

                // 위험등급 텍스트 결정
                const getRiskText = (riskLevel) => {
                    const riskTexts = {
                        1: "매우높은위험(1등급)",
                        2: "높은위험(2등급)",
                        3: "다소높은위험(3등급)",
                        4: "보통위험(4등급)",
                        5: "낮은위험(5등급)",
                        6: "매우낮은위험(6등급)",
                    };
                    return riskTexts[riskLevel] || `위험등급(${riskLevel}등급)`;
                };

                fundDiv.innerHTML = `
        <!-- 메타 데이터 -->
        <section class="fund-item-section fund-meta">
            <div class="fund-name-container">
                <h3 class="fund-name">
                    ${fund.fundName || ""}
                </h3>
            </div>
            <ul class="fund-detail">
                <li>설정일&nbsp;${formatDate(fund.establishDate)}</li>
                <li>기준가&nbsp;${formatNumber(fund.nav)}</li>
                <li>순자산&nbsp;${fund.aum || 0}억</li>
            </ul>
            <div class="badge-list">
                <span class="badge company">${
                    fund.managementCompany || ""
                }</span>
                <span class="badge type">${fund.fundType || ""}</span>
                <span class="badge region">${fund.investmentRegion || ""}</span>
                <span class="badge risk ${getRiskClass(fund.riskLevel)}">
                    ${getRiskText(fund.riskLevel)}
                </span>
            </div>
        </section>

        <!-- 수익률 -->
        <section class="fund-item-section fund-return">
            <div class="stat">
                <span>1개월</span>
                <strong class="${getReturnClass(fund.return1m)}">${formatReturn(
                    fund.return1m
                )}</strong>
            </div>
            <div class="stat">
                <span>3개월</span>
                <strong class="${getReturnClass(fund.return3m)}">${formatReturn(
                    fund.return3m
                )}</strong>
            </div>
            <div class="stat">
                <span>6개월</span>
                <strong class="${getReturnClass(fund.return6m)}">${formatReturn(
                    fund.return6m
                )}</strong>
            </div>
            <div class="stat">
                <span>12개월</span>
                <strong class="${getReturnClass(
                    fund.return12m
                )}">${formatReturn(fund.return12m)}</strong>
            </div>
            <div class="stat">
                <span>누적</span>
                <strong class="${getReturnClass(
                    fund.returnSince
                )}">${formatReturn(fund.returnSince)}</strong>
            </div>
        </section>
    `;
                return fundDiv;
            }

            // 숫자 포맷팅
            // function formatNumber(number) {
            //     return new Intl.NumberFormat("ko-KR").format(number);
            // }

            // 로딩 상태 표시
            function showLoading(show) {
                const loading = document.getElementById("loading");
                if (loading) {
                    loading.classList.toggle("show", show);
                }
            }

            // 더보기 버튼 상태 업데이트
            function updateLoadMoreButton() {
                const loadMoreBtn = document.getElementById("load-more-btn");
                loadMoreBtn.disabled = isLoading;
                loadMoreBtn.textContent = isLoading ? "로딩 중..." : "더보기";
            }

            // 검색 메세지 업데이트 함수
            function updateResultMessage(totalCount, isFirstLoad = false) {
                const messageElement = document.querySelector(".message");

                if (!messageElement) return;

                console.log("!! : " + isFirstLoad);
                console.log("!! : " + totalCount);

                if (isFirstLoad && totalCount > 0) {
                    // 첫 로드이고 결과가 있을 때만 메시지 표시
                    console.log("검색 메세지 업데이트");
                    messageElement.innerHTML = `
            <div class="result-summary">
                <span class="result-count">총 <strong>${totalCount.toLocaleString()}</strong>개의 펀드를 찾았습니다.</span>
            </div>
        `;
                    messageElement.classList.add("show");
                } else if (isFirstLoad && totalCount === 0) {
                    // 검색 결과가 없을 때
                    console.log("검색 결과 없음 - 메시지 표시");
                    messageElement.innerHTML = `
            <div class="result-summary no-result">
                <span class="result-count">검색 조건에 맞는 펀드가 없습니다.</span>
            </div>
        `;
                    // messageElement.classList.add("show");
                    messageElement.classList.remove("show");
                } else {
                    // 더보기 로드 시에는 메시지 숨김
                    messageElement.classList.remove("show");
                }
            }

            function setInvestTypeInfo() {
                const investTypeNames = {
                    1: "안정형",
                    2: "안정 추구형",
                    3: "위험 중립형",
                    4: "적극 투자형",
                    5: "공격 투자형",
                };

                investTypeName = investTypeNames[investType] || "알 수 없음";

                // 투자성향 요소 가져옴
                const investTypeElement =
                    document.getElementById("invest-type");
                if (investTypeElement) {
                    // 텍스트 설정
                    investTypeElement.textContent = investTypeName;

                    // 기존 클래스 제거
                    investTypeElement.className = "";

                    // 투자성향에 맞는 클래스 추가
                    if (investType >= 1 && investType <= 5) {
                        investTypeElement.classList.add(
                            `invest-type-${investType}`
                        );
                    }
                }
            }

            // 🔥 메시지 영역을 보존하면서 펀드 아이템만 삭제하는 함수
            function clearFundItems() {
                const fundList = document.getElementById("fund-list");
                const messageElement = fundList.querySelector(".message");

                // 메시지 영역 임시 저장
                let messageHTML = "";
                if (messageElement) {
                    messageHTML = messageElement.outerHTML;
                }

                // 전체 클리어
                fundList.innerHTML = "";

                // 메시지 영역만 다시 추가
                if (messageHTML) {
                    fundList.insertAdjacentHTML("afterbegin", messageHTML);
                }
            }

            // 검색 버튼 클릭 시 - 수정필요
            document
                .getElementById("fundForm")
                .addEventListener("submit", function (e) {
                    e.preventDefault();

                    // FormData로 체크된 값들 수집
                    const formData = new FormData(
                        document.getElementById("fundForm")
                    );
                    const params = new URLSearchParams();

                    // 체크된 값들을 URLSearchParams에 추가
                    for (let [key, value] of formData.entries()) {
                        params.append(key, value);
                    }

                    // 전역 변수에 필터 파라미터 저장
                    currentFilters = params.toString();

                    console.log("적용된 필터:", currentFilters); // 디버깅용

                    // 페이지 초기화
                    currentPage = 1;
                    hasMoreData = true;

                    // 기존 결과 클리어
                    document.getElementById("fund-list").innerHTML = "";

                    // 🔥 메시지 영역만 보존하고 펀드 아이템들만 삭제
                    // clearFundItems();

                    // 새로운 검색 실행
                    loadMoreFunds(); // 이때 isFirstLoad = true가 됨
                });

            // function showLoading() {
            //     loading.hidden = false;
            // }
            // function hideLoading() {
            //     loading.hidden = true;
            // }

            // 에러 메시지 표시
            // function showErrorMessage(message) {
            //     const errorContainer =
            //         document.getElementById("errorContainer");
            //     errorContainer.innerHTML = `
            //     <div class="error-message">
            //         ${message}
            //     </div>
            // `;
            // }

            // 에러 메시지 제거
            // function clearErrorMessage() {
            //     const errorContainer =
            //         document.getElementById("errorContainer");
            //     errorContainer.innerHTML = "";
            // }

            // 무한 스크롤 옵션 (선택사항)
            // window.addEventListener('scroll', function() {
            //     if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 1000) {
            //         loadMoreFunds();
            //     }
            // });
        </script>

        <!-- Thymeleaf 데이터 전달을 위한 메타 태그 -->
        <meta name="invest-type" th:content="${investType}" />
        <meta name="user-id" th:content="${userId}" />
    </body>
</html>
