<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Thymeleaf 데이터 전달을 위한 메타 태그 -->
    <meta name="invest-type" th:content="${investType}" />
    <meta name="user-id" th:content="${userId}" />

    <!-- 페이지 스타일 -->
    <link rel="stylesheet" href="/css/fund/fund_list.css" />
    <!-- 프레그먼트 스타일 -->
    <link rel="stylesheet" href="/css/userHeader.css" />
    <link rel="stylesheet" href="/css/footer.css" />
    <link rel="stylesheet" href="/css/fundMainHeader.css" />

    <!-- 제목 -->
    <title>펀드 맞춤 목록</title>
</head>
<body>
<!-- 헤더 영역 -->
<th:block th:replace="fragments/userHeader :: userHeader"></th:block>
<th:block th:replace="fragments/fundMainHeader :: fundMainHeader"></th:block>

<!-- 메인 영역 -->
<div class="container">
    <!-- 제목 영역 -->
    <div class="title-container">
        <h1 class="title">맞춤 펀드 목록</h1>
        <span class="title-user-info">
                현재 회원님의 투자성향은
                <span id="invest-type">Unknown</span>입니다
            </span>
    </div>

    <!-- 필터 영역 -->
    <form id="fundForm" class="filter-container">
        <!-- 위험등급 -->
        <fieldset class="row">
            <legend class="row-label">위험등급</legend>
            <div class="options">
                <label for="risk1">
                    <input type="checkbox" id="risk1" name="riskLevels" value="1" /> 매우높은위험(1등급)
                </label>
                <label for="risk2">
                    <input type="checkbox" id="risk2" name="riskLevels" value="2" /> 높은위험(2등급)
                </label>
                <label for="risk3">
                    <input type="checkbox" id="risk3" name="riskLevels" value="3" /> 다소높은위험(3등급)
                </label>
                <label for="risk4">
                    <input type="checkbox" id="risk4" name="riskLevels" value="4" /> 보통위험(4등급)
                </label>
                <label for="risk5">
                    <input type="checkbox" id="risk5" name="riskLevels" value="5" /> 낮은위험(5등급)
                </label>
                <label for="risk6">
                    <input type="checkbox" id="risk6" name="riskLevels" value="6" /> 매우낮은위험(6등급)
                </label>
            </div>
        </fieldset>

        <!-- 펀드유형 -->
        <fieldset class="row">
            <legend class="row-label">펀드유형</legend>
            <div class="options">
                <label for="type_bond">
                    <input type="checkbox" id="type_bond" name="fundTypes" value="채권형" /> 채권형
                </label>
                <label for="type_bmix">
                    <input type="checkbox" id="type_bmix" name="fundTypes" value="채권혼합형" /> 채권혼합형
                </label>
                <label for="type_smix">
                    <input type="checkbox" id="type_smix" name="fundTypes" value="주식혼합형" /> 주식혼합형
                </label>
                <label for="type_stock">
                    <input type="checkbox" id="type_stock" name="fundTypes" value="주식형" /> 주식형
                </label>
                <label for="type_deriv">
                    <input type="checkbox" id="type_deriv" name="fundTypes" value="파생상품형" /> 파생상품형
                </label>
                <label for="type_fof">
                    <input type="checkbox" id="type_fof" name="fundTypes" value="재간접투자형" /> 재간접
                </label>
                <label for="type_etc">
                    <input type="checkbox" id="type_etc" name="fundTypes" value="수익증권_기타" /> 수익증권_기타
                </label>
            </div>
        </fieldset>

        <!-- 투자 지역 -->
        <fieldset class="row">
            <legend class="row-label">투자 지역</legend>
            <div class="options">
                <label for="reg_korea">
                    <input type="checkbox" id="reg_korea" name="regions" value="한국" /> 한국
                </label>
                <label for="reg_global">
                    <input type="checkbox" id="reg_global" name="regions" value="글로벌" /> 글로벌
                </label>
                <label for="reg_usa">
                    <input type="checkbox" id="reg_usa" name="regions" value="미국" /> 미국
                </label>
                <label for="reg_vietnam">
                    <input type="checkbox" id="reg_vietnam" name="regions" value="베트남" /> 베트남
                </label>
                <label for="reg_euro">
                    <input type="checkbox" id="reg_euro" name="regions" value="유로권" /> 유로권
                </label>
                <label for="reg_brazil">
                    <input type="checkbox" id="reg_brazil" name="regions" value="브라질" /> 브라질
                </label>
                <label for="reg_german">
                    <input type="checkbox" id="reg_german" name="regions" value="독일" /> 독일
                </label>
                <label for="reg_china">
                    <input type="checkbox" id="reg_china" name="regions" value="중국" /> 중국
                </label>
                <label for="reg_western_europe">
                    <input type="checkbox" id="reg_western_europe" name="regions" value="서유럽" /> 서유럽
                </label>
                <label for="reg_india">
                    <input type="checkbox" id="reg_india" name="regions" value="인도" /> 인도
                </label>
                <label for="reg_brics">
                    <input type="checkbox" id="reg_brics" name="regions" value="브릭스" /> 브릭스
                </label>
                <label for="reg_north_america">
                    <input type="checkbox" id="reg_north_america" name="regions" value="북미" /> 북미
                </label>
                <label for="reg_japan">
                    <input type="checkbox" id="reg_japan" name="regions" value="일본" /> 일본
                </label>
                <label for="reg_south_east_asia">
                    <input type="checkbox" id="reg_south_east_asia" name="regions" value="동남아" /> 동남아
                </label>
            </div>
        </fieldset>

        <!-- 검색 버튼 -->
        <div class="row filter-btn-container">
            <button type="submit" class="filter-btn">필터 검색</button>
        </div>
    </form>

    <!-- 펀드 메인 콘텐츠 영역 -->
    <div id="fund-content" class="fund-content">
        <!-- 검색 결과 메세지 영역 -->
        <div class="message"></div>

        <!-- 펀드 리스트 영역 -->
        <div id="fund-list" class="fund-list"></div>

        <!-- 더보기 버튼 영역 -->
        <div class="load-more-container">
            <button id="load-more-btn" class="load-more-btn" onclick="loadMoreFunds()">더보기</button>
        </div>
    </div>

    <!-- 로딩 오버레이 -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>펀드 정보를 불러오는 중...</p>
    </div>
</div>

<!-- 하단 고정 비교바 -->
<div class="compare-bar" id="compareBar">
    <div class="compare-bar-content">
        <div class="compare-info">
            <div class="compare-count" id="compareCount">0개 선택</div>
            <div class="selected-funds-preview" id="fundsPreview"></div>
        </div>
        <div class="compare-actions">
            <button class="clear-all-btn" id="clearAllBtn">전체 해제</button>
            <button class="compare-btn" id="compareBtn" disabled>펀드 비교하기</button>
        </div>
    </div>
</div>

<!-- 비교 모달 -->
<div class="modal-overlay" id="compareModal">
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">펀드 비교 분석</h2>
            <div class="modal-close-btn" id="modalCloseBtn" role="button" tabindex="0">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </div>
        </div>
        <div class="modal-body">
            <div class="compare-table-container">
                <table class="compare-table" id="compareTable">
                    <thead>
                    <tr>
                        <th class="table-header-label">구분</th>
                    </tr>
                    </thead>
                    <tbody id="compareTableBody"></tbody>
                </table>
            </div>
            <div class="aiAnaylseContainer" id="aiAnaylseContainer"></div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" id="aiAnalyseBtn">AI 분석</button>
                <button class="modal-btn modal-btn-primary" id="modalCloseBtn2">확인</button>
            </div>
        </div>
    </div>
</div>

<!-- 푸터 영역 -->
<th:block th:replace="fragments/footer :: siteFooter"></th:block>

<script>
    let currentPage = 1, pageSize = 10, isLoading = false, hasMoreData = true;
    let investType = null, investTypeName = "", currentFilters = "";
    const selectedFunds = [], MAX_COMPARE_COUNT = 3;

    document.addEventListener("DOMContentLoaded", () => {
        const invMeta = document.querySelector('meta[name="invest-type"]');
        if (invMeta) investType = parseInt(invMeta.getAttribute("content"));
        setInvestTypeInfo();
        loadMoreFunds();
    });

    async function loadMoreFunds() {
        if (isLoading || !hasMoreData) return;
        isLoading = true; showLoading(true); updateLoadMoreButton();
        const isFirst = currentPage === 1;
        try {
            let url = `/api/funds/list?page=${currentPage}&size=${pageSize}&investType=${investType}&active=true`;
            if (currentFilters) url += `&${currentFilters}`;
            const res = await fetch(url), json = await res.json();
            if (json.success) {
                renderFunds(json.data.funds);
                if (isFirst) updateResultMessage(json.pagination.total, true);
                currentPage++; hasMoreData = json.pagination.hasNext;
                document.getElementById("load-more-btn").style.display = hasMoreData ? "block" : "none";
            } else if (isFirst) updateResultMessage(0, true);
        } catch {
            if (isFirst) updateResultMessage(0, true);
        } finally {
            isLoading = false; showLoading(false); updateLoadMoreButton();
        }
    }

    function renderFunds(funds) {
        const container = document.getElementById("fund-list");
        funds.forEach(f => {
            const el = createFundElement(f);
            restoreSelectionState(el, f.fundId);
            container.appendChild(el);
        });
    }
    function restoreSelectionState(el, id) {
        if (selectedFunds.some(s => s.id == id)) {
            el.classList.add("selected");
            const btn = el.querySelector(".compare-add-btn");
            btn.classList.add("selected");
            btn.textContent = "선택됨";
        }
    }

    function createFundElement(fund) {
        const div = document.createElement("div");
        div.className = "fund-item"; div.dataset.id = fund.fundId;
        const getCls = v => v > 0 ? "pos" : v < 0 ? "neg" : "zero";
        const fmt = v => v == null ? "0.00%" : `${v.toFixed(2)}%`;
        const num = v => v == null ? "0" : v.toLocaleString();
        const dateStr = d => d ? d.replace(/-/g, ".") : "";
        const riskTxt = n=>({1:"매우높은위험(1등급)",2:"높은위험(2등급)",3:"다소높은위험(3등급)",4:"보통위험(4등급)",5:"낮은위험(5등급)",6:"매우낮은위험(6등급)"}[n]||`위험등급(${n}등급)`);
        const riskCls = n=>`risk-${n}`;
        const badge = r=> r? `<span class="badge region">${r}</span>` : "";
        div.innerHTML = `
            <section class="fund-item-section fund-meta">
                <h3 class="fund-name"><a href="/fund/${fund.fundId}" class="fund-name-link">${fund.fundName||""}</a></h3>
                <ul class="fund-detail">
                    <li>설정일 ${dateStr(fund.establishDate)}</li>
                    <li>기준가 ${num(fund.nav)}</li>
                    <li>순자산 ${fund.aum||0}억</li>
                </ul>
                <div class="badge-list">
                    <span class="badge company">${fund.managementCompany||""}</span>
                    <span class="badge type">${fund.fundType||""}</span>
                    ${badge(fund.investmentRegion)}
                    <span class="badge risk ${riskCls(fund.riskLevel)}">${riskTxt(fund.riskLevel)}</span>
                </div>
                <div class="fund-item-section fund-compare-check">
                    <button class="compare-add-btn" data-fund-id="${fund.fundId}" data-fund-name="${fund.fundName||""}">비교담기</button>
                </div>
            </section>
            <section class="fund-item-section fund-return">
                <div class="stat"><span>1개월</span><strong class="${getCls(fund.return1m)}">${fmt(fund.return1m)}</strong></div>
                <div class="stat"><span>3개월</span><strong class="${getCls(fund.return3m)}">${fmt(fund.return3m)}</strong></div>
                <div class="stat"><span>6개월</span><strong class="${getCls(fund.return6m)}">${fmt(fund.return6m)}</strong></div>
                <div class="stat"><span>12개월</span><strong class="${getCls(fund.return12m)}">${fmt(fund.return12m)}</strong></div>
                <div class="stat"><span>누적</span><strong class="${getCls(fund.returnSince)}">${fmt(fund.returnSince)}</strong></div>
            </section>
        `;
        return div;
    }

    function showLoading(show) {
        document.getElementById("loading").classList.toggle("show", show);
    }
    function updateLoadMoreButton() {
        const btn = document.getElementById("load-more-btn");
        btn.disabled = isLoading;
        btn.textContent = isLoading ? "로딩 중..." : "더보기";
    }
    function updateResultMessage(total, first=false) {
        const msg = document.querySelector(".message");
        if (!msg) return;
        if (first) {
            msg.innerHTML = `<div class="result-summary"><span class="result-count">총 <strong>${total.toLocaleString()}</strong>개의 펀드를 조회했습니다.</span></div>`;
            msg.classList.add("show");
        } else {
            msg.classList.remove("show");
        }
    }
    function setInvestTypeInfo() {
        const names = {1:"안정형",2:"안정 추구형",3:"위험 중립형",4:"적극 투자형",5:"공격 투자형"};
        investTypeName = names[investType]||"알 수 없음";
        const el = document.getElementById("invest-type");
        el.textContent = investTypeName;
        el.className = "";
        if (investType>=1 && investType<=5) el.classList.add(`invest-type-${investType}`);
    }

    document.getElementById("fundForm").addEventListener("submit", e=>{
        e.preventDefault();
        const data = new FormData(e.target), params = new URLSearchParams();
        for (let [k,v] of data.entries()) params.append(k,v);
        currentFilters = params.toString();
        currentPage=1; hasMoreData=true;
        document.getElementById("fund-list").innerHTML="";
        loadMoreFunds();
    });

    document.addEventListener("click", e=>{
        if (e.target.classList.contains("compare-add-btn")) {
            const id = e.target.dataset.fundId, name = e.target.dataset.fundName;
            const item = e.target.closest(".fund-item");
            const idx = selectedFunds.findIndex(f=>f.id===id);
            if (idx>-1) {
                selectedFunds.splice(idx,1);
                item.classList.remove("selected");
                e.target.classList.remove("selected");
                e.target.textContent="비교담기";
            } else {
                if (selectedFunds.length>=MAX_COMPARE_COUNT) return alert(`최대 ${MAX_COMPARE_COUNT}개까지 선택 가능합니다.`);
                selectedFunds.push({id,name});
                item.classList.add("selected");
                e.target.classList.add("selected");
                e.target.textContent="선택됨";
            }
            updateCompareBar();
        }
    });

    function updateCompareBar() {
        const bar = document.getElementById("compareBar"),
              countEl = document.getElementById("compareCount"),
              preview = document.getElementById("fundsPreview"),
              btn = document.getElementById("compareBtn");
        if (selectedFunds.length>0) {
            bar.classList.add("show");
            countEl.textContent=`${selectedFunds.length}개 선택`;
            preview.innerHTML = selectedFunds.map((f,i)=>`
                <div class="fund-preview">
                    <div class="fund-preview-name">${f.name}</div>
                    <button class="fund-remove-btn" onclick="removeFund(${i})">×</button>
                </div>
            `).join("");
            btn.disabled = selectedFunds.length<2;
        } else bar.classList.remove("show");
    }
    function removeFund(i) {
        const f = selectedFunds[i];
        selectedFunds.splice(i,1);
        const item = document.querySelector(`[data-id="${f.id}"]`);
        if (item) {
            item.classList.remove("selected");
            const b = item.querySelector(".compare-add-btn");
            b.classList.remove("selected"); b.textContent="비교담기";
        }
        updateCompareBar();
    }
    document.getElementById("clearAllBtn").addEventListener("click", ()=>{
        selectedFunds.forEach(f=>{
            const item = document.querySelector(`[data-id="${f.id}"]`);
            if (item) {
                item.classList.remove("selected");
                const b = item.querySelector(".compare-add-btn");
                b.classList.remove("selected"); b.textContent="비교담기";
            }
        });
        selectedFunds.length=0;
        updateCompareBar();
    });
    document.getElementById("compareBtn").addEventListener("click", openCompareModal);

    function openCompareModal() {
        if (selectedFunds.length<2) return alert("최소 2개 이상의 펀드를 선택해주세요.");
        document.getElementById("compareModal").classList.add("show");
        renderCompareTable();
        document.body.style.overflow="hidden";
    }
    function closeCompareModal() {
        document.getElementById("compareModal").classList.remove("show");
        document.getElementById("aiAnaylseContainer").innerHTML="";
        document.body.style.overflow="auto";
    }
    document.getElementById("modalCloseBtn").addEventListener("click", closeCompareModal);
    document.getElementById("modalCloseBtn2").addEventListener("click", closeCompareModal);
    document.getElementById("compareModal").addEventListener("click", e=>{ if(e.target===e.currentTarget) closeCompareModal(); });
    document.addEventListener("keydown", e=>{ if(e.key==="Escape") closeCompareModal(); });

    function renderCompareTable() {
        const table = document.getElementById("compareTable"),
              thead = table.querySelector("thead tr"),
              tbody = document.getElementById("compareTableBody");
        // 헤더
        thead.querySelectorAll("th:not(.table-header-label)").forEach(th=>th.remove());
        selectedFunds.forEach(f=>{
            const th = document.createElement("th");
            th.className="fund-header-cell";
            th.textContent = f.name.length>50?f.name.slice(0,50)+"...":f.name;
            thead.appendChild(th);
        });
        // 바디
        const items = [
            { label:"펀드유형", key:"fundType" },
            { label:"투자지역", key:"investmentRegion" },
            { label:"위험등급", key:"riskLevel" },
            { label:"운용사", key:"managementCompany" },
            { label:"기준가", key:"nav" },
            { label:"순자산", key:"aum" },
            { label:"3개월 수익률", key:"return3m" },
            { label:"12개월 수익률", key:"return12m" }
        ];
        tbody.innerHTML="";
        items.forEach(item=>{
            const tr = document.createElement("tr");
            const tdLabel = document.createElement("td"); tdLabel.className="row-label"; tdLabel.textContent=item.label;
            tr.appendChild(tdLabel);
            selectedFunds.forEach(fundSel=>{
                // 현재 화면 로드된 아이템에서 가져오기
                const el = document.querySelector(`.fund-item[data-id="${fundSel.id}"]`);
                let val = null;
                if (el) {
                    // dataset or innerText에서 추출 (간단화)
                    val = el.querySelector(`.stat strong`).textContent;
                }
                const td = document.createElement("td"); td.className="fund-data-cell";
                td.textContent = val || "-";
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
    }

    document.getElementById("aiAnalyseBtn").addEventListener("click", ()=>{
        const container = document.getElementById("aiAnaylseContainer");
        if (!selectedFunds.length) return alert("분석할 펀드를 선택해주세요.");
        const params = new URLSearchParams();
        selectedFunds.forEach(f=>params.append("fundId", f.id));
        params.append("invert", investType);
        container.innerHTML = `<div class="loading-analyse-container"><div class="loading-analyse-spinner"></div><p>AI가 펀드를 분석하고 있습니다...</p></div>`;
        fetch(`/ai/compare?${params.toString()}`).then(r=>{
            if(!r.ok) throw new Error(r.status);
            return r.text();
        }).then(html=> container.innerHTML=html)
          .catch(err=> container.innerHTML=`<div class="error-container"><p>❌ AI 분석 중 오류가 발생했습니다.</p><p>오류: ${err.message}</p></div>`);
    });
</script>
</body>
</html>