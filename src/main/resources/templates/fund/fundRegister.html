<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>펀드 등록</title>
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/admin/admin_layout.css"/>
  <link rel="stylesheet" href="/css/admin/fund_register.css"/>
</head>
<body>
<div class="layout">
  <div th:replace="admin/admin_header :: adminHeader"></div>
  <div class="main-wrapper">
    <div th:replace="admin/admin_aside :: adminAside"></div>
    <main class="content">
      <div class="container edit-container">
        <h2 class="fund-list-title">펀드 등록</h2>
        <!-- 펀드 검색 -->
        <form id="fundForm" method="post" enctype="multipart/form-data" th:action="@{/fund/register}">
          <label>펀드 이름 :
            <input type="text" id="fundName" onclick="openModal()" readonly>
            <button type="button" onclick="openModal()">펀드 검색</button>
          </label>
          <input type="hidden" name="fundId" id="fundId"><br>
          <div id="fundDetailBox" class="fund-detail-box" style="display:none;">
            <h3>펀드 기본 정보</h3>
            <table class="fund-detail-table">
              <tr><th>펀드유형</th><td id="fundType"></td></tr>
              <tr><th>운용지역</th><td id="investmentRegion"></td></tr>
              <tr><th>설정일</th><td id="establishDate"></td></tr>
              <tr><th>총보수율</th><td id="totalExpenseRatio"></td></tr>
              <tr><th>위험등급</th><td id="riskLevel"></td></tr>
              <tr><th>운용사</th><td id="managementCompany"></td></tr>
            </table>
          </div>
          <label class="themeSelect">테마 : 
            <select id="themeSelect" name="fundTheme" required>
              <option value="">테마 선택</option>
              <option value="주식형">주식형</option>
              <option value="채권형">채권형</option>
              <option value="혼합형">혼합형</option>
              <option value="대체투자형">대체투자형</option>
              <option value="기타">기타</option>
            </select>
          </label><br><br>


          <!-- 탭 버튼 -->
          <div class="tab-buttons">
            <button type="button" id="tab-terms" onclick="showTab('terms')">약관</button>
            <button type="button" id="tab-manual" onclick="showTab('manual')">상품설명서</button>
            <button type="button" id="tab-prospectus" onclick="showTab('prospectus')">투자설명서</button>
          </div>

          <!-- 탭 영역 -->
          <div id="terms" class="tab active">
            <input type="hidden" name="docType" value="약관">
            <br>
            <input type="hidden" name="fileFormat" value="PDF">
            <label>파일 업로드: <input type="file" name="fileTerms" accept="application/pdf" required></label><br>
          </div>

          <div id="manual" class="tab"> 
            <input type="hidden" name="docType" value="상품설명서">
            <br>
            <input type="hidden" name="fileFormat" value="PDF">
            <label>파일 업로드: <input type="file" name="fileManual" accept="application/pdf" required></label><br>
          </div>

          <div id="prospectus" class="tab">
            <input type="hidden" name="docType" value="투자설명서">
            <br>
            <input type="hidden" name="fileFormat" value="PDF">
            <label>파일 업로드: <input type="file" name="fileProspectus" accept="application/pdf" required></label><br>
          </div>
          <br>
          <div class="register-btn-div">
            <button type="submit">펀드 등록</button>
          </div>
        </form>

        <!-- 모달창 -->
        <div id="fundModal" class="modal">
          <h3 class="modal-title">펀드 검색</h3>
          <div class="modal-search-div">
            <input type="text" id="searchKeyword" placeholder="입력값 없이 검색 시 전체목록 출력">
            <button class="modal-search-btn" onclick="searchFund()">검색</button>
          </div>
          <ul id="fundResult"></ul>
          <button class="modal-close-btn" onclick="closeModal()">닫기</button>
        </div>

        <script>
          function openModal() {
            $('#fundModal').addClass('active');
          }

          function closeModal() {
            $('#fundModal').removeClass('active');
          }

          function searchFund() {
            const keyword = $('#searchKeyword').val();
            $.get('/api/funds/search', { name: keyword }, function(data) {
              let listHtml = '';
              data.forEach(fund => {
                listHtml += `<li onclick="selectFund('${fund.fundId}', '${fund.fundName}')">${fund.fundName}</li>`;
              });
              $('#fundResult').html(listHtml);
            });
          }

          function selectFund(id, name) {
            $('#fundId').val(id);
            $('#fundName').val(name);
            closeModal();
          }

          function showTab(tabId) {
            $('.tab').removeClass('active');
            $('#' + tabId).addClass('active');
          }

          // 등록 버튼 누를 때 form 수동 처리
          document.getElementById('fundForm').addEventListener('submit', function(e) {
            e.preventDefault(); // 기본 제출 막기

            const form = e.target;
            const formData = new FormData();

            // JSON 형식의 data 객체 생성
            const data = {
              fundId: form.fundId.value,
              fundTheme: form.fundTheme.value,
              fundPayout: "",        // 정책용 필드 (지금은 비워둠)
              fundActive: false,     // 정책용 필드 (지금은 false로 대체)
              fundRelease: new Date().toISOString().slice(0, 10), // 오늘 날짜 사용
              docTitle: "",          // 서버에서 자동 생성
              docType: "",           // 서버에서 반복적으로 처리
              fileFormat: "PDF"      // 고정
            };

            formData.append("data", new Blob([JSON.stringify(data)], { type: "application/json" }));
            formData.append("fileTerms", form.fileTerms.files[0]);
            formData.append("fileManual", form.fileManual.files[0]);
            formData.append("fileProspectus", form.fileProspectus.files[0]);

            fetch('/fund/register', {
              method: 'POST',
              body: formData
            })
            .then(response => response.json())
            .then(result => {
              alert(result.message || '등록 성공');
            })
            .catch(err => {
              alert('오류 발생: ' + err.message);
            });
          });

          function selectFund(id, name) {
            $('#fundId').val(id);
            $('#fundName').val(name);
            closeModal();

            // fundId로 상세 정보 요청
            $.get(`/api/funds/${id}`, function(data) {
              $('#fundDetailBox').show();
              $('#fundType').text(data.fundType || '-');
              $('#investmentRegion').text(data.investmentRegion || '-');
              $('#establishDate').text(data.establishDate || '-');
              $('#totalExpenseRatio').text(data.totalExpenseRatio || '-');
              $('#riskLevel').text(data.riskLevel || '-');
              $('#managementCompany').text(data.managementCompany || '-');
            }).fail(() => {
              $('#fundDetailBox').hide();
              alert('펀드 정보를 불러오지 못했습니다.');
            });
          }

          // 파일 등록 시 탭 버튼 색상 변경
          const fileToTabMap = {
            fileTerms: 'tab-terms',
            fileManual: 'tab-manual',
            fileProspectus: 'tab-prospectus'
          };

          Object.entries(fileToTabMap).forEach(([fileInputName, tabId]) => {
            const input = document.querySelector(`input[name="${fileInputName}"]`);
            const tab = document.getElementById(tabId);
            if (input && tab) {
              input.addEventListener('change', function () {
                tab.classList.toggle('file-attached', this.files.length > 0);
              });
            }
          });
        </script>
      </div>
    </main>
  </div><!--main-wrapper end-->
</div><!--layout end-->
</body>
</html>
