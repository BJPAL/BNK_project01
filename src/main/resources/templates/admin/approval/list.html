<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>내 결재 요청 내역</title>

  <!-- FontAwesome & SweetAlert2 (토스트 재활용 시) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

  <style>
    :root{
      --primary:#337D89;--primary-dark:#2a6673;
      --bg:#eef3f5;--card:#fff;--border:#e0e0e0;--shadow:rgba(0,0,0,.06);
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);font-family:"Segoe UI",sans-serif;color:#333;}

    .approval-container{max-width:1200px;margin:40px auto;padding:50px 60px;
                        background:var(--card);border-radius:16px;
                        box-shadow:0 8px 24px var(--shadow);}

    h1{display:flex;align-items:center;gap:10px;font-size:30px;color:var(--primary);margin:0 0 40px;}
    h1::before{content:"\f560";font-family:'Font Awesome 5 Free';font-weight:900;
               color:var(--primary);font-size:28px;}

    .approval-section{margin-bottom:60px;}
    .approval-section h2{margin:0 0 24px;font-size:22px;color:var(--primary);
                         border-left:6px solid var(--primary);padding-left:12px;}

    /* 카드 그리드 */
    .card-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:24px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;
          box-shadow:0 4px 12px var(--shadow);padding:24px;transition:.25s;display:flex;flex-direction:column;}
    .card:hover{transform:translateY(-6px);box-shadow:0 10px 24px var(--shadow);}

    .card-top{display:flex;justify-content:space-between;gap:18px;margin-bottom:14px;}

    .card-title a{font-size:18px;font-weight:700;color:var(--primary);text-decoration:none;line-height:1.3;}
    .card-title a:hover{text-decoration:underline;}

    .card-content{flex:1;line-height:1.5;margin-bottom:18px;white-space:pre-line;}

    .card-footer{display:flex;justify-content:space-between;align-items:center;font-size:14px;color:#666;}

    /* 상태 배지 + 모래시계 */
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:9999px;
           font-size:12px;font-weight:700;color:#fff;white-space:nowrap;}
    .badge-pending{background:#f39c12;}
    .badge-waiting{background:#2980b9;}
    .badge-rejected{background:#e74c3c;}
    .badge-published{background:#2ecc71;}
    @keyframes hourFlip{0%{transform:rotate(0)}50%{transform:rotate(180deg)}100{transform:rotate(360deg)}}
    .hourglass-anim{animation:hourFlip 2.8s linear infinite;display:inline-block;transform-origin:center;}

    /* 버튼 */
    .btn{display:inline-flex;align-items:center;gap:6px;padding:7px 16px;border:none;border-radius:8px;
         font-size:14px;font-weight:600;cursor:pointer;color:#fff;transition:filter .25s;}
    .btn:hover{filter:brightness(.9);}
    .btn-publish{background:var(--primary);}
    .btn-edit{background:#8e44ad;}

    /* 페이징 */
    .pagination{text-align:center;margin-top:30px;}
    .pagination a{display:inline-block;margin:0 6px;padding:6px 14px;border-radius:8px;
                  border:1px solid var(--primary);color:var(--primary);font-weight:700;text-decoration:none;}
    .pagination a.active{background:var(--primary);color:#fff;}

    .reject-reason{background:#fdecea;color:#c0392b;padding:8px 12px;border-radius:8px;font-size:14px;margin-top:8px;}
  </style>
</head>

<body>
<div class="approval-container">
  <h1>내 결재 요청 내역</h1>

  <!-- ========== 결재대기 ========== -->
  <div class="approval-section">
    <h2>결재대기</h2>
    <div class="card-list">
      <div class="card" th:each="approval:${pendingPage.content}">
        <div class="card-top">
          <div class="card-title">
            <a th:href="@{'/admin/approval/detail/'+${approval.approvalId}}"
               th:text="${approval.title}"></a>
          </div>
          <span class="badge badge-pending">
            <i class="fas fa-hourglass-half hourglass-anim"></i>
            <span th:text="${'대기 D+'+
              T(java.time.Duration).between(approval.regDate,
                                            T(java.time.LocalDateTime).now()).toDays()}">대기 D+0</span>
          </span>
        </div>

        <div class="card-content" th:text="${approval.content}"></div>

        <div class="card-footer">
          <span th:text="${#temporals.format(approval.regDate,'yyyy-MM-dd HH:mm')}"></span>
        </div>
      </div>
    </div>

    <div class="pagination" th:if="${pendingPage.totalPages>1}">
      <a th:each="i:${#numbers.sequence(0,pendingPage.totalPages-1)}"
         th:href="@{/admin/approval/my-list(pendingPage=${i},waitingPage=0,rejectedPage=0,publishedPage=0)}"
         th:text="${i+1}" th:classappend="${i==pendingPage.number}?'active':''"></a>
    </div>
  </div>

  <!-- ========= 배포대기 ========= -->
  <div class="approval-section">
    <h2>배포대기</h2>
    <div class="card-list">
      <div class="card" th:each="approval:${waitingPage.content}">
        <div class="card-top">
          <div class="card-title">
            <a th:href="@{'/admin/approval/detail/'+${approval.approvalId}}"
               th:text="${approval.title}"></a>
          </div>
          <span class="badge badge-waiting">
          <i class="fas fa-hourglass-half hourglass-anim"></i>
          <span th:text="${'배포대기 D+'+
            T(java.time.Duration).between(approval.regDate,
                                          T(java.time.LocalDateTime).now()).toDays()}">
            배포대기 D+0
          </span>
        </span>
        </div>

        <div class="card-content" th:text="${approval.content}"></div>

        <div class="card-footer">
          <span th:text="${#temporals.format(approval.regDate,'yyyy-MM-dd HH:mm')}"></span>

          <!--  교체 : 모달 호출을 위해 onsubmit 추가 -->
          <form th:action="@{'/admin/approval/publish/'+${approval.approvalId}}"
                method="post" style="margin:0;"
                onsubmit="return openPublishModal(event,this);">
            <button type="submit" class="btn btn-publish">
              <i class="fas fa-rocket"></i> 배포
            </button>
          </form>
        </div>
      </div>
    </div>

    <div class="pagination" th:if="${waitingPage.totalPages>1}">
      <a th:each="i:${#numbers.sequence(0,waitingPage.totalPages-1)}"
         th:href="@{/admin/approval/my-list(pendingPage=0,waitingPage=${i},rejectedPage=0,publishedPage=0)}"
         th:text="${i+1}" th:classappend="${i==waitingPage.number}?'active':''"></a>
    </div>
  </div>

  <!-- ========== 반려 ========== -->
  <div class="approval-section">
    <h2>반려</h2>
    <div class="card-list">
      <div class="card" th:each="approval:${rejectedPage.content}">
        <div class="card-top">
          <div class="card-title">
            <a th:href="@{'/admin/approval/detail/'+${approval.approvalId}}"
               th:text="${approval.title}"></a>
          </div>
          <span class="badge badge-rejected">반려</span>
        </div>

        <div class="card-content">
          <p th:text="${approval.content}"></p>
          <p class="reject-reason" th:text="${approval.rejectReason}"></p>
        </div>

        <div class="card-footer">
          <span th:text="${#temporals.format(approval.regDate,'yyyy-MM-dd HH:mm')}"></span>
          <a th:href="@{'/admin/approval/edit/'+${approval.approvalId}}"
             class="btn btn-edit">
            <i class="fas fa-redo"></i> 재기안
          </a>
        </div>
      </div>
    </div>

    <div class="pagination" th:if="${rejectedPage.totalPages>1}">
      <a th:each="i:${#numbers.sequence(0,rejectedPage.totalPages-1)}"
         th:href="@{/admin/approval/my-list(pendingPage=0,waitingPage=0,rejectedPage=${i},publishedPage=0)}"
         th:text="${i+1}" th:classappend="${i==rejectedPage.number}?'active':''"></a>
    </div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function openPublishModal(e, form){
    e.preventDefault();
    Swal.fire({
      title: '정말로 배포하시겠습니까?',
      icon: 'question',
      showCancelButton: true,
      confirmButtonText: '배포',
      cancelButtonText: '취소',
      reverseButtons: true
    }).then(res=>{
      if(res.isConfirmed){ form.submit(); }
    });
    return false;
  }
</script>
</body>
</html>