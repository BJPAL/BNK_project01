<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Admin Setting</title>
  <style>
    /* 모달 배경 */
    #adminModal {
      display: none; /* 기본은 숨김 */
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto; /* 내용이 넘칠 경우 스크롤 */
      background-color: rgba(0, 0, 0, 0.4); /* 반투명 검정 배경 */
    }

    /* 모달 콘텐츠 박스 */
    #adminModalContent {
      background-color: #fff;
      margin: 10% auto; /* 위에서 10%, 가운데 정렬 */
      padding: 20px;
      border: 1px solid #ccc;
      width: 400px; /* 너비 고정 */
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      border-radius: 5px;
    }

    /* 닫기 버튼 (예시용) */
    #closeModalBtn {
      float: right;
      cursor: pointer;
      font-size: 16px;
      background: none;
      border: none;
      color: #888;
    }

    #closeModalBtn:hover {
      color: #333;
    }
  </style>
</head>
<body>
<div th:replace="admin/a_header :: adminHeader"></div>
<div class="tab-container">
  <div class="tabs">
    <button class="tab-button" data-tab="tab1">관리자 조회 및 권한수정</button>
    <button class="tab-button" data-tab="tab2">관리자 등록</button>
  </div>

  <div id="tab1" class="tab-content" style="display: none;"> <!--전체 관리자 목록-->
    <h2>관리자 조회 및 권한수정</h2>
    <!-- ROLE 필터 드롭다운 -->
    <label for="roleFilter">권한별 검색 :</label>
    <select id="roleFilter">
      <option value="">전체</option>
      <option value="super">Super</option>
      <option value="planner">Planner</option>
      <option value="approver">Approver</option>
      <option value="cs">CS</option>
    </select>

    <div id="adminListContainer"></div>
    <div id="adminModal" style="display: none;">
      <div id="adminModalContent"></div>
    </div>

    <p>※ Notice ※</p>
    <p>이름 클릭시 상세정보 조회 및 수정 가능합니다</p>
  </div>

  <div id="tab2" class="tab-content" style="display: none;"> <!--관리자 등록-->
    <h2>관리자 등록</h2>
    <div th:replace="admin/super/admin_register :: admin-register-content"></div>
  </div>
</div>

<script>
  const buttons = document.querySelectorAll('.tab-button');
  const contents = document.querySelectorAll('.tab-content');

  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-tab');

      contents.forEach(content => {
        content.style.display = content.id === target ? 'block' : 'none';
      });
    });
  });

  //관리자 목록 탭 script
  document.querySelector('.tab-button[data-tab="tab1"]').addEventListener('click', () => {
  document.querySelector('#roleFilter').value = '';
  fetch('/admin/list' , {credentials: 'include'}) // 전체 관리자 조회
    .then(res => res.text())
    .then(html => {
      if (html.includes("id=\"loginForm\"")) {
        alert("세션이 만료되었습니다. 다시 로그인해주세요.");
        window.location.href = "/admin/login";
      } else {
        document.querySelector('#adminListContainer').innerHTML = html;
      }
    })
    .catch(err => {
      console.error('관리자 목록 조회 실패', err);
    });
  });

  const roleSelect = document.querySelector('#roleFilter');
  roleSelect.addEventListener('change', () => {
    const role = roleSelect.value;

    fetch(`/admin/list?role=${role}`, {credentials: 'include'})
      .then(res => res.text())
      .then(html => {
        if (html.includes("id=\"loginForm\"")) {
        alert("세션이 만료되었습니다. 다시 로그인해주세요.");
        window.location.href = "/admin/login";
        } else {
          document.querySelector('#adminListContainer').innerHTML = html;
        }
      })
      .catch(err => {
        console.error('필터 조회 실패', err);
        document.querySelector('#adminListContainer').innerText = '오류 발생';
      });
  });


  //관리자 등록 탭 누를 때 마다 폼 초기화
  document.querySelector('.tab-button[data-tab="tab2"]').addEventListener('click', () => {
    const form = document.querySelector('#adminForm');
    const notice_p = document.getElementById("notice_p");
    if (form) form.reset();
    notice_p.innerText="";
  });

  // 관리자 등록 기능 script 부분
    let isDuplicateChecked = false; //중복 확인 여부 저장
    let isAvailable = false; // 사용 가능한 상태인지 저장

    //중복 확인 버튼 클릭 시 실행
    function checkDuplicate(){
        const adminname = document.getElementById("adminname").value;
        const notice_p = document.getElementById("notice_p");

        if(adminname.length < 3){
            notice_p.innerText = "아이디는 3자 이상이어야 합니다";
            notice_p.style.color = "red";
            isDuplicateChecked = false;
            isAvailable = false;
            return;
        }
        fetch(`/admin/check-id?adminname=` + encodeURIComponent(adminname), {credentials: 'include'})
            .then(res => res.json())
            .then(isDuplicate => {
                isDuplicateChecked = true;
                if (isDuplicate) {
                    notice_p.textContent = "이미 사용 중인 아이디입니다.";
                    notice_p.style.color = "red";
                    isAvailable = false;
                } else {
                    notice_p.textContent = "사용 가능한 아이디입니다.";
                    notice_p.style.color = "green";
                    isAvailable = true;
                }
            });
    }
    // 아이디 입력값이 변경되면 중복 확인 상태 초기화
    document.getElementById("adminname").addEventListener("input", () => {
    isDuplicateChecked = false;
    isAvailable = false;
    document.getElementById("notice_p").textContent = "아이디 중복 확인이 필요합니다.";
    document.getElementById("notice_p").style.color = "orange";
    });

    // 폼 제출 전 중복 확인 여부 검사
    document.getElementById("adminForm").addEventListener("submit", function (e) {
        if (!isDuplicateChecked || !isAvailable) {
            e.preventDefault();
            alert("아이디 중복 확인을 시행해주세요");
        }
        else{
          alert("관리자 등록이 완료되었습니다");
        }
    });

    // 관리자 상세정보 모달 & 수정, 삭제, 갱신 처리
    document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('adminModal');
    const modalContent = document.getElementById('adminModalContent');

    //이벤트 위임: adminListContainer 내부의 클릭 이벤트 감지
    document.getElementById('adminListContainer').addEventListener('click', e => {
      // 클릭한 대상이 .open-modal을 포함하는지 확인
      if (e.target.classList.contains('open-modal')) {
        e.preventDefault(); // 링크 이동 방지
        const adminId = e.target.dataset.id;

        fetch(`/admin/detail/${adminId}`)
          .then(res => res.text())
          .then(html => {
            modalContent.innerHTML = html;
            modal.style.display = 'block';
            attachModalEvents(); // 모달 내부 버튼 이벤트 바인딩
          });
          }
        });
      });


    // 모달 내부 이벤트 바인딩 함수
    function attachModalEvents() {
      const modal = document.getElementById('adminModal');
      const submitBtn = document.getElementById('submitEditBtn');
      const deleteBtn = document.getElementById('deleteAdminBtn');
      const closeBtn = document.getElementById('closeModalBtn');

      submitBtn.addEventListener('click', () => {
        const id = document.getElementById('editAdminId').value;
        const role = document.getElementById('editRole').value;

        fetch('/admin/updateRole', {
          credentials: 'include',
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ admin_id: id, role: role })
        }).then(() => {
          modal.style.display = 'none';
          alert("권한 변경이 완료되었습니다");
          reloadAdminList();
        });
      });

      deleteBtn.addEventListener('click', () => {
        const id = document.getElementById('editAdminId').value;
        if (!confirm('정말 삭제하시겠습니까?')) return;

        fetch(`/admin/delete/${id}`, { method: 'DELETE' })
          .then(() => {
            modal.style.display = 'none';
            alert("삭제 완료되었습니다");
            reloadAdminList();
          });
      });

      closeBtn.addEventListener('click', () => {
        modal.style.display = 'none';
      });
    }

    function reloadAdminList() {
      fetch('/admin/list', {credentials: 'include'})
        .then(res => res.text())
        .then(html => {
          document.getElementById('adminListContainer').innerHTML = html;
        });
    }

</script>
</body>
</html>